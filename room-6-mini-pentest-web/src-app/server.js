const express = require('express');
const sqlite3 = require('sqlite3').verbose();
const app = express();
const PORT = 3000;

app.use(express.urlencoded({ extended: true }));
app.use(express.json());
app.use(express.static('public'));

// Base de données SQLite
const db = new sqlite3.Database(':memory:');

db.serialize(() => {
    db.run(`CREATE TABLE users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT UNIQUE,
        password TEXT,
        email TEXT,
        role TEXT DEFAULT 'user'
    )`);
    
    db.run(`CREATE TABLE posts (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        title TEXT,
        content TEXT,
        author_id INTEGER,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )`);
    
    // Données de test
    db.run(`INSERT INTO users (username, password, email, role) VALUES 
        ('admin', 'admin123', 'admin@test.com', 'admin'),
        ('user1', 'password123', 'user1@test.com', 'user')`);
    
    db.run(`INSERT INTO posts (title, content, author_id) VALUES 
        ('Premier post', 'Contenu du premier post', 1),
        ('Deuxième post', 'Contenu du deuxième post', 2)`);
});

// Page d'accueil
app.get('/', (req, res) => {
    res.sendFile(__dirname + '/public/index.html');
});

// Login vulnérable - Injection SQL possible
app.post('/login', (req, res) => {
    const { username, password } = req.body;
    // VULNÉRABLE : Injection SQL possible
    const query = `SELECT * FROM users WHERE username = '${username}' AND password = '${password}'`;
    db.get(query, (err, user) => {
        if (err || !user) {
            return res.send(`
                <html>
                <body>
                    <h1>Erreur de connexion</h1>
                    <p>Identifiants incorrects</p>
                    <a href="/">Retour</a>
                </body>
                </html>
            `);
        }
        res.cookie('session', user.id);
        res.redirect('/dashboard');
    });
});

// Dashboard
app.get('/dashboard', (req, res) => {
    res.sendFile(__dirname + '/public/dashboard.html');
});

// API - Recherche de posts (XSS réfléchi)
app.get('/api/search', (req, res) => {
    const query = req.query.q || '';
    // VULNÉRABLE : XSS réfléchi
    res.json({ results: `Résultats pour : ${query}` });
});

// API - Liste des posts
app.get('/api/posts', (req, res) => {
    db.all('SELECT * FROM posts', (err, posts) => {
        if (err) {
            return res.status(500).json({ error: err.message });
        }
        res.json(posts);
    });
});

// API - Créer un post (XSS stocké possible)
app.post('/api/posts', (req, res) => {
    const { title, content } = req.body;
    // VULNÉRABLE : Pas de validation ni échappement
    db.run('INSERT INTO posts (title, content, author_id) VALUES (?, ?, ?)', 
        [title, content, 1], 
        function(err) {
            if (err) {
                return res.status(500).json({ error: err.message });
            }
            res.json({ id: this.lastID, title, content });
        }
    );
});

app.listen(PORT, () => {
    console.log(`Application vulnérable démarrée sur http://localhost:${PORT}`);
    console.log(`Cette application contient plusieurs vulnérabilités pour l'apprentissage`);
});
